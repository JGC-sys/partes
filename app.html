// =================================== 
// GOOGLE APPS SCRIPT - API BACKEND 
// Para PWA Registro de Partes
// CON VALIDACIÓN DE USUARIO ACTIVO + MOTIVOS
// =================================== 

// Nombres de las pestañas
const SHEET_USUARIOS = 'Usuarios';
const SHEET_CLIENTES = 'Clientes';
const SHEET_REGISTROS = 'Registros';
const SHEET_MOTIVOS = 'Motivos';

// Función principal que recibe todas las peticiones
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    switch(action) {
      case 'login':
        return login(data.usuario, data.password);
      
      case 'getClientes':
        if (!isUserActive(data.usuario)) {
          return createResponse(false, 'Tu sesión ha expirado. Vuelve a iniciar sesión.');
        }
        return getClientes();
      
      case 'getReferencias':
        if (!isUserActive(data.usuario)) {
          return createResponse(false, 'Tu sesión ha expirado. Vuelve a iniciar sesión.');
        }
        return getReferencias(data.cliente);
      
      // ✅ NUEVA FUNCIÓN: Obtener motivos
      case 'getMotivos':
        if (!isUserActive(data.usuario)) {
          return createResponse(false, 'Tu sesión ha expirado. Vuelve a iniciar sesión.');
        }
        return getMotivos();
      
      case 'saveRegistro':
        if (!isUserActive(data.registro.usuario)) {
          return createResponse(false, 'Tu sesión ha expirado. Vuelve a iniciar sesión.');
        }
        return saveRegistro(data.registro);
      
      default:
        return createResponse(false, 'Acción no válida');
    }
  } catch(error) {
    return createResponse(false, 'Error: ' + error.message);
  }
}

// Permitir peticiones GET (para testing)
function doGet(e) {
  return ContentService.createTextOutput(
    JSON.stringify({success: true, message: 'API funcionando correctamente'})
  ).setMimeType(ContentService.MimeType.JSON);
}

// =================================== 
// VALIDACIÓN DE USUARIO ACTIVO
// =================================== 

function isUserActive(usuario) {
  if (!usuario) {
    return false;
  }
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_USUARIOS);
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[0] === usuario) {
      return true;
    }
  }
  
  return false;
}

// =================================== 
// FUNCIONES DE NEGOCIO
// =================================== 

// LOGIN
function login(usuario, password) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_USUARIOS);
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[0] === usuario && row[1] === password) {
      return createResponse(true, 'Login exitoso', { 
        usuario: row[0], 
        nombreCompleto: row[2] 
      });
    }
  }
  
  return createResponse(false, 'Usuario o contraseña incorrectos');
}

// OBTENER CLIENTES
function getClientes() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_CLIENTES);
  const data = sheet.getDataRange().getValues();
  
  const clientes = [...new Set(data.slice(1).map(row => row[0]))].filter(Boolean);
  
  return createResponse(true, 'Clientes obtenidos', { clientes });
}

// OBTENER REFERENCIAS
function getReferencias(cliente) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_CLIENTES);
  const data = sheet.getDataRange().getValues();
  
  const referencias = data
    .slice(1)
    .filter(row => row[0] === cliente)
    .map(row => row[1])
    .filter(Boolean);
  
  return createResponse(true, 'Referencias obtenidas', { referencias });
}

// ✅ NUEVA FUNCIÓN: OBTENER MOTIVOS
function getMotivos() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_MOTIVOS);
  const data = sheet.getDataRange().getValues();
  
  // Extraer motivos (columna 0, saltar encabezado)
  const motivos = data
    .slice(1)
    .map(row => row[0])
    .filter(Boolean);
  
  return createResponse(true, 'Motivos obtenidos', { motivos });
}

// GUARDAR REGISTRO (ACTUALIZADO CON MOTIVO)
function saveRegistro(registro) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_REGISTROS);
  
  // Formatear fecha de registro completa con segundos
  const ahora = new Date();
  const dia = String(ahora.getDate()).padStart(2, '0');
  const mes = String(ahora.getMonth() + 1).padStart(2, '0');
  const año = ahora.getFullYear();
  const horas = String(ahora.getHours()).padStart(2, '0');
  const minutos = String(ahora.getMinutes()).padStart(2, '0');
  const segundos = String(ahora.getSeconds()).padStart(2, '0');
  const fechaRegistro = `${dia}/${mes}/${año} ${horas}:${minutos}:${segundos}`;
  
  // ✅ Preparar fila CON EL NUEVO CAMPO "motivo" y fecha completa
  const newRow = [
    registro.usuario,
    registro.cliente,
    registro.referencia,
    registro.cantidad,
    registro.motivo,
    registro.fechaEntrada,    // DD/MM/YYYY HH:MM
    registro.fechaSalida,     // DD/MM/YYYY HH:MM
    fechaRegistro             // DD/MM/YYYY HH:MM:SS (formato completo)
  ];
  
  sheet.appendRow(newRow);
  
  return createResponse(true, 'Registro guardado correctamente');
}

// =================================== 
// FUNCIÓN AUXILIAR PARA RESPUESTAS
// =================================== 

function createResponse(success, message, data = null) {
  const response = { 
    success: success, 
    message: message 
  };
  
  if (data) {
    response.data = data;
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}
